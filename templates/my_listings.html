{% extends "base.html" %}
{% block title %}My Listings{% endblock %}
{% block head %}
<style>
    .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;}
    .add-btn { background: #2ecc71; color: #121212; font-weight: 600; padding: 10px 20px; border-radius: 8px; text-decoration: none; cursor: pointer; border: none;}
    .filter-bar { background-color: #1e1e1e; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #333; }
    .filter-form { display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: flex-end; }
    .form-group input, .form-group select { padding: 12px; background-color: #2b2b2b; border: 1px solid #444; border-radius: 8px; color: #e0e0e0; font-size: 1em; }
    .listings-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; }
    .product-card { background: #1e1e1e; border-radius: 12px; overflow: hidden; text-decoration: none; color: #e0e0e0; border: 1px solid #333; display: flex; flex-direction: column; }
    .product-card img { width: 100%; height: 200px; object-fit: cover; background-color: #333;}
    .product-info { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
    .product-name { font-size: 1.2em; font-weight: 600; margin: 5px 0; }
    .product-price { font-size: 1.1em; color: #2ecc71; }
    .product-status { font-size: 0.9em; color: #e53935; font-weight: 500; text-transform: uppercase;}
    .product-status.available { color: #2ecc71; }
    .card-actions { margin-top: auto; padding-top: 15px; border-top: 1px solid #333; display: flex; gap: 10px; }
    .edit-btn, .delete-btn { flex: 1; padding: 8px; border-radius: 8px; text-align: center; text-decoration: none; border: none; cursor: pointer; font-weight: 500;}
    .edit-btn { background-color: #333; color: #e0e0e0; }
    .delete-btn { background-color: #e53935; color: white; width: 100%;}

    /* Modal Styles */
    .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); }
    .modal-content { background-color: #1e1e1e; margin: 5% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; padding-bottom: 15px; margin-bottom: 20px; }
    .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
    .modal-form { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .form-group-full { grid-column: 1 / -1; }
    .modal-form label { margin-bottom: 8px; display: block; color: #aaa; }
    .modal-form input, .modal-form select, .modal-form textarea { width: 100%; padding: 10px; background-color: #2b2b2b; border: 1px solid #444; border-radius: 8px; color: #e0e0e0; box-sizing: border-box;}
    .checkbox-group { display: flex; align-items: center; gap: 10px; grid-column: 1 / -1; }
    .modal-form button { grid-column: 1 / -1; background: #2ecc71; color: #121212; padding: 12px; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 600; cursor: pointer; margin-top: 10px; }
</style>
{% endblock %}
{% block content %}
<div class="container">
    <div class="header-bar">
        <h1>My Listings</h1>
        <button class="add-btn" onclick="showModal('addListingModal')"><i class="fas fa-plus"></i> Add New</button>
    </div>

    <div class="filter-bar">
        <form method="GET" action="{{ url_for('my_listings') }}" class="filter-form">
            <div class="form-group">
                <input type="text" name="search" placeholder="Search your listings..." value="{{ search_query or '' }}">
            </div>
            <div class="form-group">
                <select name="sort_by" onchange="this.form.submit()">
                    <option value="newest" {% if current_sort == 'newest' %}selected{% endif %}>Sort By: Newest</option>
                    <option value="price_asc" {% if current_sort == 'price_asc' %}selected{% endif %}>Sort By: Price Low to High</option>
                    <option value="price_desc" {% if current_sort == 'price_desc' %}selected{% endif %}>Sort By: Price High to Low</option>
                </select>
            </div>
        </form>
    </div>

    <div class="listings-grid">
        {% for product in products %}
            <div class="product-card">
                <img src="{{ url_for('static', filename='images/' + product.first_image) if product.first_image and product.first_image != 'placeholder.jpg' else 'https://placehold.co/600x400/333/FFF?text=No+Image' }}" alt="{{ product.name }}">
                <div class="product-info">
                    <p class="product-status {{ 'available' if not product.is_sold else '' }}">{{ 'Available' if not product.is_sold else 'Sold' }}</p>
                    <h3 class="product-name">{{ product.name }}</h3>
                    <p class="product-price">${{ "%.2f"|format(product.market_price) }}</p>
                    <p>{{ product.category }}</p>
                    <div class="card-actions">
                         <button class="edit-btn" data-product='{{ product | tojson | safe }}' onclick="showEditModal(this.dataset.product)"><i class="fas fa-edit"></i> Edit</button>
                        <form action="{{ url_for('delete_listing', product_id=product.product_id) }}" method="POST" style="flex: 1;">
                            <button type="submit" class="delete-btn" onclick="return confirm('Are you sure you want to permanently delete this listing?')"><i class="fas fa-trash"></i> Delete</button>
                        </form>
                    </div>
                </div>
            </div>
        {% else %}
            <p>You have not listed any products yet. Click "Add New" to get started.</p>
        {% endfor %}
    </div>
</div>

<!-- Add Listing Modal -->
<div id="addListingModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add a New Product</h2>
            <span class="close-btn" onclick="hideModal('addListingModal')">&times;</span>
        </div>
        <form action="{{ url_for('add_listing') }}" method="POST" class="modal-form" enctype="multipart/form-data">
            <div class="form-group form-group-full"><label>Product Title</label><input type="text" name="name" required></div>
            <div class="form-group"><label>Category</label><input type="text" name="category" required></div>
            <div class="form-group"><label>Price ($)</label><input type="number" name="market_price" step="0.01" min="0" required></div>
            <div class="form-group"><label>Condition</label><input type="text" name="condition" placeholder="e.g., Used, Like New"></div>
            <div class="form-group"><label>Brand</label><input type="text" name="brand"></div>
            <div class="form-group"><label>Model</label><input type="text" name="model"></div>
            <div class="form-group"><label>Year of Manufacture</label><input type="number" name="year_of_manufacture" placeholder="e.g., 2020" min="1900"></div>
            <div class="form-group"><label>Color</label><input type="text" name="color"></div>
            <div class="form-group"><label>Material</label><input type="text" name="material"></div>
            <div class="form-group"><label>Dimensions (L,W,H)</label><input type="text" name="dimensions"></div>
            <div class="form-group"><label>Weight</label><input type="text" name="weight"></div>
            <div class="form-group form-group-full"><label>Upload Images</label><input type="file" name="images" multiple accept="image/*"></div>
            <div class="form-group form-group-full"><label>Description</label><textarea name="description" rows="3"></textarea></div>
            <div class="form-group form-group-full"><label>Working Condition Details</label><textarea name="working_condition_details" rows="2"></textarea></div>
            <div class="checkbox-group"><input type="checkbox" id="add_packaging" name="has_original_packaging" value="1"><label for="add_packaging">Original Packaging Included</label></div>
            <div class="checkbox-group"><input type="checkbox" id="add_manual" name="has_manual" value="1"><label for="add_manual">Manual/Instructions Included</label></div>
            <button type="submit">Add Item</button>
        </form>
    </div>
</div>

<!-- Edit Listing Modal -->
<div id="editListingModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Listing</h2>
            <span class="close-btn" onclick="hideModal('editListingModal')">&times;</span>
        </div>
        <form id="editForm" method="POST" class="modal-form" enctype="multipart/form-data">
             <div class="form-group form-group-full"><label>Product Title</label><input type="text" id="edit_name" name="name" required></div>
            <div class="form-group"><label>Category</label><input type="text" id="edit_category" name="category" required></div>
            <div class="form-group"><label>Price ($)</label><input type="number" id="edit_price" name="market_price" step="0.01" required></div>
            <div class="form-group"><label>Condition</label><input type="text" id="edit_condition" name="condition"></div>
            <div class="form-group"><label>Brand</label><input type="text" id="edit_brand" name="brand"></div>
            <div class="form-group"><label>Model</label><input type="text" id="edit_model" name="model"></div>
            <div class="form-group"><label>Year of Manufacture</label><input type="number" id="edit_year" name="year_of_manufacture"></div>
            <div class="form-group"><label>Color</label><input type="text" id="edit_color" name="color"></div>
            <div class="form-group"><label>Material</label><input type="text" id="edit_material" name="material"></div>
            <div class="form-group"><label>Dimensions (L,W,H)</label><input type="text" id="edit_dimensions" name="dimensions"></div>
            <div class="form-group"><label>Weight</label><input type="text" id="edit_weight" name="weight"></div>
            <div class="form-group form-group-full"><label>Upload New Images</label><input type="file" name="images" multiple accept="image/*"></div>
            <div class="form-group form-group-full"><label>Current Image Filenames (comma-separated)</label><input type="text" id="edit_images" name="existing_images"></div>
            <div class="form-group form-group-full"><label>Description</label><textarea id="edit_description" name="description" rows="3"></textarea></div>
            <div class="form-group form-group-full"><label>Working Condition Details</label><textarea id="edit_working_details" name="working_condition_details" rows="2"></textarea></div>
            <div class="checkbox-group"><input type="checkbox" id="edit_packaging" name="has_original_packaging" value="1"><label for="edit_packaging">Original Packaging Included</label></div>
            <div class="checkbox-group"><input type="checkbox" id="edit_manual" name="has_manual" value="1"><label for="edit_manual">Manual/Instructions Included</label></div>
            <button type="submit">Save Changes</button>
        </form>
    </div>
</div>

<script>
    function showModal(modalId) { document.getElementById(modalId).style.display = 'block'; }
    function hideModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
    
    function showEditModal(productData) {
        const product = JSON.parse(productData);
        const form = document.getElementById('editForm');
        form.action = `/edit_listing/${product.product_id}`;
        
        document.getElementById('edit_name').value = product.name || '';
        document.getElementById('edit_category').value = product.category || '';
        document.getElementById('edit_price').value = product.market_price || '';
        document.getElementById('edit_condition').value = product.condition || '';
        document.getElementById('edit_brand').value = product.brand || '';
        document.getElementById('edit_model').value = product.model || '';
        document.getElementById('edit_year').value = product.year_of_manufacture || '';
        document.getElementById('edit_color').value = product.color || '';
        document.getElementById('edit_material').value = product.material || '';
        document.getElementById('edit_dimensions').value = product.dimensions || '';
        document.getElementById('edit_weight').value = product.weight || '';
        document.getElementById('edit_images').value = product.image_url || '';
        document.getElementById('edit_description').value = product.description || '';
        document.getElementById('edit_working_details').value = product.working_condition_details || '';
        document.getElementById('edit_packaging').checked = product.has_original_packaging;
        document.getElementById('edit_manual').checked = product.has_manual;

        showModal('editListingModal');
    }

    window.onclick = function(event) {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        });
    }
</script>
{% endblock %}

